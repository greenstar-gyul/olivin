name: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ë´‡

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened]
  pull_request_review_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      EVENT_NAME: ${{ github.event_name }}
      REPO: ${{ github.repository }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_USER: ${{ github.event.issue.user.login }}
      ISSUE_BODY: ${{ github.event.issue.body }}
      ISSUE_COMMENT_USER: ${{ github.event.comment.user.login }}
      ISSUE_COMMENT_BODY: ${{ github.event.comment.body }}
      ISSUE_COMMENT_URL: ${{ github.event.comment.html_url }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_USER: ${{ github.event.pull_request.user.login }}
      PR_BODY: ${{ github.event.pull_request.body }}
      PR_COMMENT_USER: ${{ github.event.comment.user.login }}
      PR_COMMENT_BODY: ${{ github.event.comment.body }}
      PR_COMMENT_URL: ${{ github.event.comment.html_url }}

    steps:
      - name: ë””ìŠ¤ì½”ë“œë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
        run: |
          if [[ "$EVENT_NAME" == "issues" ]]; then
            URL="https://github.com/${REPO}/issues/${ISSUE_NUMBER}"
            WEBHOOK="${{ secrets.DISCORD_ISSUE_WEBHOOK_URL }}"
            
            MESSAGE="[ì´ìŠˆ ìƒì„±] #${ISSUE_NUMBER} - ${ISSUE_TITLE}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nì‘ì„±ì : ${ISSUE_USER}\në§í¬   : ${URL}\n\në‚´ìš©:\n${ISSUE_BODY}"

          elif [[ "$EVENT_NAME" == "pull_request" ]]; then
            URL="https://github.com/${REPO}/pull/${PR_NUMBER}"
            WEBHOOK="${{ secrets.DISCORD_PR_WEBHOOK_URL }}"
            
            MESSAGE="[PR ìƒì„±] #${PR_NUMBER} - ${PR_TITLE}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nì‘ì„±ì : ${PR_USER}\në§í¬   : ${URL}\n\në‚´ìš©:\n${PR_BODY}"

          elif [[ "$EVENT_NAME" == "issue_comment" ]]; then
            WEBHOOK="${{ secrets.DISCORD_ISSUE_WEBHOOK_URL }}"
            
            MESSAGE="[ì´ìŠˆ ëŒ“ê¸€] #${ISSUE_NUMBER}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nì‘ì„±ì : ${ISSUE_COMMENT_USER}\në§í¬   : ${ISSUE_COMMENT_URL}\n\nëŒ“ê¸€:\n${ISSUE_COMMENT_BODY}"

          elif [[ "$EVENT_NAME" == "pull_request_review_comment" ]]; then
            WEBHOOK="${{ secrets.DISCORD_PR_WEBHOOK_URL }}"
            
            MESSAGE="[PR ëŒ“ê¸€] #${PR_NUMBER}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nì‘ì„±ì : ${PR_COMMENT_USER}\në§í¬   : ${PR_COMMENT_URL}\n\nëŒ“ê¸€:\n${PR_COMMENT_BODY}"

          else
            MESSAGE="âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ì…ë‹ˆë‹¤: ${EVENT_NAME}"
            WEBHOOK="${{ secrets.DISCORD_ISSUE_WEBHOOK_URL }}"
          fi

          # echo -eë¡œ ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ë¥¼ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
          FORMATTED_MESSAGE=$(echo -e "$MESSAGE")

          # Discord 2000ì ì œí•œ ì²˜ë¦¬
          if [[ ${#FORMATTED_MESSAGE} -gt 2000 ]]; then
            # 1900ìê¹Œì§€ ìë¥´ê³  "... (ìƒëµ)" ì¶”ê°€
            FORMATTED_MESSAGE="${FORMATTED_MESSAGE:0:1900}...\n\nğŸ“ ìì„¸í•œ ë‚´ìš©ì€ ë§í¬ ì°¸ì¡°"
          fi

          # JSON í˜ì´ë¡œë“œ ìƒì„± ë° ì „ì†¡
          jq -n --arg content "$FORMATTED_MESSAGE" '{content: $content}' | \
          curl -H "Content-Type: application/json" \
               -X POST \
               -d @- \
               "$WEBHOOK"
