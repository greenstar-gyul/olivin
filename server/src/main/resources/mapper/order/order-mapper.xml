<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.olivin.app.order.mapper.OrdersMapper">
    <sql id="orderIdPrefix">
    'POR'
    </sql>
    <!--  -->
    <select id="selectCompInfo" resultType="UserCompanyVO" parameterType="string">
		SELECT
			e.employee_id,
			e.comp_id,
			e.emp_name,
			c.comp_name,
			c.comp_type,
			c.note
		FROM
			employees e
				LEFT JOIN companys c ON e.comp_id = c.comp_id
		WHERE employee_id = #{empId}
    </select>
	<!-- select -->
    <select id="selectAllList" resultType="OrdersVO" parameterType="SearchOrdersVO">
        SELECT
            order_id,
            order_title,
            creator_id,
            creator_name,
            order_type,
            get_datacode_name(order_type) as order_type_name,
            order_from_id,
            reason,
            get_datacode_name(reason) as reason_name,
            order_date,
            order_status,
            get_datacode_name(order_status) as order_status_name,
            approver_id,
            approver_name,
            approval_date,
            total_amount,
            due_date,
            remark,
            order_to_id,
            order_to,
            order_from
        FROM
            purchase_orders
        <where>
            <if test="orderId != null and orderId != ''">
                AND order_id LIKE '%'||#{orderId}||'%'
            </if>
            <if test="orderTitle != null and orderTitle != ''">
                AND order_title LIKE '%'||#{orderTitle}||'%'
            </if>
            <if test="creatorName != null and creatorName != ''">
                AND creator_name LIKE '%'||#{creatorName}||'%'
            </if>
            <if test="approverName != null and approverName != ''">
                AND approver_name LIKE '%'||#{approverName}||'%'
            </if>
            <if test="orderType != null and orderType != ''">
                AND order_type = #{orderType}
            </if>
            <if test="orderFromId != null and orderFromId != ''">
                AND order_from_id = #{orderFromId}
            </if>
            <if test="orderFrom != null and orderFrom != ''">
                AND order_from LIKE '%'||#{orderFrom}||'%'
            </if>
            <if test="orderToId != null and orderToId != ''">
                AND order_to_id = #{orderToId}
            </if>
            <if test="orderTo != null and orderTo != ''">
                AND order_to LIKE '%'||#{orderTo}||'%'
            </if>
            <if test="orderStatus != null and orderStatus != ''">
                AND order_status = #{orderStatus}
            </if>
	        <if test="orderDateStart != null and orderDateStart != ''">
	            AND order_date &gt;= #{orderDateStart}
	        </if>
	        <if test="orderDateEnd != null and orderDateEnd != ''">
	            AND order_date &lt;= #{orderDateEnd}
	        </if>
	        <if test="dueDateStart != null and dueDateStart != ''">
	            AND due_date &gt;= #{dueDateStart}
	        </if>
	        <if test="dueDateEnd != null and dueDateEnd != ''">
	            AND due_date &lt;= #{dueDateEnd}
	        </if>
        </where>
        ORDER BY order_id DESC
    </select>

    <select id="selectOneByOrderId" resultType="OrdersVO" parameterType="string">
        SELECT
            order_id,
            order_title,
            creator_id,
            creator_name,
            order_type,
            get_datacode_name(order_type) as order_type_name,
            order_from_id,
            reason,
            get_datacode_name(reason) as reason_name,
            order_date,
            order_status,
            get_datacode_name(order_status) as order_status_name,
            approver_id,
            approver_name,
            approval_date,
            total_amount,
            due_date,
            remark,
            order_to_id,
            order_to,
            order_from
        FROM
            purchase_orders
        WHERE
            order_id = #{orderId}
    </select>
    
    <select id="selectDetailsByOrderId" resultType="OrdersDetailVO" parameterType="string">
        SELECT
            po_id,
            order_id,
            product_id,
            product_name,
            quantity,
            get_datacode_name(unit) as unit,
            category,
            vendor_id,
            vendor_name,
            price
        FROM
            purchase_orders_d
        WHERE
            order_id = #{orderId}
    </select>
    <!-- 
    <select id="SelectDetailList" resultType="map" parameterType="string">
        SELECT
            o.order_id,
            o.order_title,
            od.product_name,
            od.quantity,
            od.price,
            od.unit
        FROM
            purchase_orders o
        JOIN
            purchase_orders_d od ON o.order_id = od.order_id
        WHERE
            o.order_id = #{orderId}
    </select> -->
    
    
	<!-- insert -->
    <insert id="insertOne" parameterType="OrdersVO">
        <selectKey keyProperty="orderId" resultType="string" order="BEFORE">
        SELECT
            <include refid="orderIdPrefix"/> || TO_CHAR(SYSDATE, 'YYYYMMDD') ||
            LPAD(NVL(MAX(TO_NUMBER(SUBSTR(order_id, LENGTH(<include refid="orderIdPrefix"/> || TO_CHAR(SYSDATE, 'YYYYMMDD')) + 1))), 0) + 1, 3, '0')
        FROM purchase_orders
        WHERE order_id LIKE <include refid="orderIdPrefix"/> || TO_CHAR(SYSDATE, 'YYYYMMDD') || '%'
        </selectKey>
        INSERT INTO purchase_orders (
           order_id,
           order_title,
           creator_id,
           creator_name,
           order_type,
           order_from_id,
           order_from,
           order_to_id,
           order_to,
           reason,
           order_date,
           order_status,
           total_amount,
           due_date,
           remark
        ) VALUES (
            #{orderId},
            #{orderTitle},
            #{creatorId},
            #{creatorName},
            #{orderType},
            #{orderFromId},
            #{orderFrom},
            #{orderToId},
            #{orderTo},
            #{reason},
            #{orderDate},
            #{orderStatus},
            #{totalAmount},
            #{dueDate},
            #{remark}
        )
    </insert>

    <insert id="insertDetailOne" parameterType="OrdersDetailVO">
        INSERT INTO purchase_orders_d (
            po_id,
            order_id,
            product_id,
            product_name,
            quantity,
            unit,
            category,
            vendor_id,
            vendor_name,
            price
        ) VALUES (
            #{poId},
            #{orderId},
            #{productId},
            #{productName},
            #{quantity},
            #{unit},
            #{category},
            #{vendorId},
            #{vendorName},
            #{price}
        )
    </insert>
	
	
	<!-- delete -->
    <delete id="deleteOrder" parameterType="string">
        DELETE FROM
            purchase_orders
        WHERE
            order_id = #{orderId}
    </delete>
    
    <delete id="deleteOrderDetails" parameterType="string">
        DELETE FROM
            purchase_orders_d
        WHERE
            order_id = #{orderId}
    </delete>
</mapper>