<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.olivin.app.auth.mapper.UserMapper">

    <!-- Result Map -->
    <resultMap id="UserResultMap" type="com.olivin.app.auth.service.UserVO">
        <id property="employeeId" column="EMPLOYEE_ID"/>
        <result property="compId" column="COMP_ID"/>
        <result property="compName" column="COMP_NAME"/>
        <result property="empName" column="EMP_NAME"/>
        <result property="password" column="PASSWORD"/>
        <result property="email" column="EMAIL"/>
        <result property="phone" column="PHONE"/>
        <result property="position" column="POSITION"/>
        <result property="roleId" column="ROLE_ID"/>
        <result property="status" column="STATUS"/>
        <result property="departmentId" column="DEPARTMENT_ID"/>
        <result property="roleName" column="ROLE_NAME"/>
        <result property="deptName" column="DEPT_NAME"/>
        <result property="compType" column="COMP_TYPE"/>
    </resultMap>

    <!-- 사원번호로 사용자 조회 (활성 사용자만) -->
    <select id="findByEmployeeIdAndStatusActive" parameterType="string" resultMap="UserResultMap">
        SELECT 
            e.EMPLOYEE_ID,
            e.COMP_ID,
            NVL(c.COMP_NAME, '') AS COMP_NAME,
            e.EMP_NAME,
            e.PASSWORD,
            NVL(e.EMAIL, '') AS EMAIL,
            NVL(e.PHONE, '') AS PHONE,
            NVL(e.POSITION, '') AS POSITION,
            e.ROLE_ID,
            e.STATUS,
            e.DEPARTMENT_ID,
            NVL(r.ROLE_NAME, 'USER') AS ROLE_NAME,
            NVL(d.DEPT_NAME, '') AS DEPT_NAME,
            c.COMP_TYPE AS COMP_TYPE
        FROM EMPLOYEES e
        LEFT JOIN ROLES r ON e.ROLE_ID = r.ROLE_ID
        LEFT JOIN DEPARTMENTS d ON e.DEPARTMENT_ID = d.DEPARTMENT_ID
        LEFT JOIN COMPANYS c ON e.COMP_ID = c.COMP_ID
        WHERE e.EMPLOYEE_ID = #{employeeId}
        AND e.STATUS = '050001'
    </select>

    <!-- 사원번호로 사용자 조회 -->
    <select id="findByEmployeeId" parameterType="string" resultMap="UserResultMap">
        SELECT 
            e.EMPLOYEE_ID,
            e.COMP_ID,
            NVL(c.COMP_NAME, '') AS COMP_NAME,
            e.EMP_NAME,
            e.PASSWORD,
            NVL(e.EMAIL, '') AS EMAIL,
            NVL(e.PHONE, '') AS PHONE,
            NVL(e.POSITION, '') AS POSITION,
            e.ROLE_ID,
            e.STATUS,
            e.DEPARTMENT_ID,
            NVL(r.ROLE_NAME, 'USER') AS ROLE_NAME,
            NVL(d.DEPT_NAME, '') AS DEPT_NAME,
            c.COMP_TYPE AS COMP_TYPE
        FROM EMPLOYEES e
        LEFT JOIN ROLES r ON e.ROLE_ID = r.ROLE_ID
        LEFT JOIN DEPARTMENTS d ON e.DEPARTMENT_ID = d.DEPARTMENT_ID
        LEFT JOIN COMPANYS c ON e.COMP_ID = c.COMP_ID
        WHERE e.EMPLOYEE_ID = #{employeeId}
    </select>

    <!-- 사용자의 권한 목록 조회 (안전한 버전) -->
    <select id="findPermissionsByEmployeeId" parameterType="string" resultType="com.olivin.app.auth.service.PermissionVO">
        SELECT 
            p.PERM_ID as permId,
            p.PERM_NAME as permName,
            NVL(p.PERM_DESCRIPTION, '') as permDescription,
            NVL(p.ICON, '') as icon,
            p.PARENT_TO as parentTo
        FROM PERMISSIONS p
        WHERE p.PERM_ID IN (
            SELECT DISTINCT rp.PERM_ID 
            FROM ROLE_PERMISSION rp
            INNER JOIN EMPLOYEES e ON rp.ROLE_ID = e.ROLE_ID
            WHERE e.EMPLOYEE_ID = #{employeeId}
            AND e.STATUS = '050001'
            AND rp.ROLE_ID IS NOT NULL
            AND rp.PERM_ID IS NOT NULL
        )
        ORDER BY 
            CASE WHEN p.PARENT_TO IS NULL THEN 0 ELSE 1 END,
            p.PERM_ID
    </select>

    <!-- 사용자 정보 수정 -->
    <update id="updateUser" parameterType="com.olivin.app.auth.service.UserVO">
        UPDATE EMPLOYEES SET
            EMP_NAME = #{empName},
            EMAIL = #{email},
            PHONE = #{phone},
            POSITION = #{position},
            DEPARTMENT_ID = #{departmentId},
            ROLE_ID = #{roleId},
            UPDATE_DATE = SYSDATE
        WHERE EMPLOYEE_ID = #{employeeId}
    </update>

    <!-- 사원번호 존재 확인 -->
    <select id="existsByEmployeeId" parameterType="string" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM EMPLOYEES
        WHERE EMPLOYEE_ID = #{employeeId}
    </select>

</mapper>